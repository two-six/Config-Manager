#!/bin/bash

MAINFOLDER="${HOME}/.config/config-manager"
CONFIG="${MAINFOLDER}/config"
FILESFOLDER="${MAINFOLDER}/files"

if [ $# -eq 0 ]
then
    if [ ! -d $MAINFOLDER ]
    then
        mkdir -p $MAINFOLDER
        touch ${CONFIG}
        echo $FILESFOLDER > ${CONFIG}
        mv ${HOME}/config ${CONFIG}
    fi
    if [ ! -f $CONFIG ]
    then
        touch $CONFIG
        echo $FILESFOLDER > $CONFIG
        if [ ! -d $FILESFOLDER ]
        then
            mkdir -p $FILESFOLDER
        fi
    fi
fi
FILESFOLDER=$( head -n 1 $CONFIG )

if [ $# -eq 0 ]
then
    ls $FILESFOLDER

else
    LINE=$( grep -n "NAME|$1" $CONFIG | cut -d : -f1 )
    LENGTH=$( wc -l $CONFIG | cut -d ' ' -f1 )
    for (( ; ; ))
    do
        LINE=$((LINE+1))
        CURRENT=$( sed -n $LINE'p' $CONFIG )
        if [ $CURRENT == "END" ] || [ $LINE -gt $LENGTH ] ||
               [ $( cut -d \| -f1 <<< $CURRENT ) == "COMMAND" ]
        then
            break
        fi
        if [ $LINE -gt $LENGTH ]
        then
            echo "forced end"
            break
        fi
        NAME=$( cut -d \| -f1 <<< $CURRENT )
        DESTINATION=$( cut -d \| -f2 <<< $CURRENT )
        cp -r $FILESFOLDER/$1/$NAME ~/$DESTINATION
    done
fi

if [[ $( cut -d \| -f1 <<< $CURRENT ) == "COMMAND" ]]
then
    COMMANDFILE=$( cut -d \| -f2 <<< $CURRENT )
    chmod +x $FILESFOLDER/$1/$COMMANDFILE
    exec $FILESFOLDER/$1/$COMMANDFILE
fi
